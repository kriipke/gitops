---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: addons
  namespace: argo-cd
spec:
  generators:
    - list:
        elements:
          - chart: metallb
            namespace: metallb-system
            repoURL: https://metallb.github.io/metallb
            targetRevision: 0.14.9
          - chart: vault-secrets-operator
            namespace: vault
            repoURL: https://releases.hashicorp.com/vault-secrets-operator
            targetRevision: v0.10.0
          - chart: nri-bundle
            namespace: newrelic
            repoURL: https://helm-charts.newrelic.com
            targetRevision: v1.0.0
  template:
    metadata:
      name: 'addon-{{chart}}'
    spec:
      project: default
      sources:
        - repoURL: '{{repoURL}}'
          chart: '{{chart}}'
          targetRevision: '{{targetRevision}}'
          helm:
            valueFiles:
            - $gitops/clusters/cluster0/addons/{{name}}
            releaseName: 'addon-{{.path.basename}}'
            ignoreMissingValueFiles: true
        - repoURL: git@github.com:kriipke/gitops.git
          targetRevision: HEAD
          ref: gitops
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
